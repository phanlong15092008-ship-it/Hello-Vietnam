<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diễn Đàn Du Lịch | Check-in Việt Nam</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f7f6;
      margin: 0;
      padding: 0;
    }

    /* NAVBAR */
    nav {
      background-color: #fff;
      border-bottom: 1px solid #ddd;
      padding: 12px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    nav .logo { display: flex; align-items: center; gap: 8px; }
    nav .logo img { width: 28px; height: 20px; border-radius: 3px; }
    nav .logo span { color: #f4511e; font-size: 1.2em; font-weight: bold; }
    nav .actions { display:flex; gap:12px; align-items:center; }

    /* MAIN LAYOUT */
    .main-layout {
      display: flex;
      max-width: 1300px;
      margin: 20px auto;
      padding: 0 20px;
      gap: 25px;
      align-items: flex-start;
    }

    .content-feed {
      flex: 2;
      display: flex;
      flex-direction: column; /* ép về 1 cột */
      gap: 20px;
    }

    .sidebar {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .module-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 20px;
    }

    /* FORM */
    #postForm input[type="text"], #postForm textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
    }
    #postForm button {
      background:#f4511e;color:#fff;padding:10px;border:none;border-radius:8px;cursor:pointer;
    }

    /* POST CARD */
    .post-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      width: 100%;
      box-sizing: border-box;
    }
    .post-card .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
    }
    .post-card .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
    }
    .post-image img {
      width: 100%;
      height: auto;
      display: block;
    }
    .post-body { padding: 10px 15px 15px; color:#333; }
    .post-footer {
      padding: 10px 15px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 20px;
      color: #606770;
    }

    /* small helpers */
    .muted { color:#777; font-size:0.9em; }

    @media (max-width: 900px) {
      .main-layout { flex-direction: column; }
      .content-feed, .sidebar { width: 100%; }
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo">
      <a href="#" class="flex items-center space-x-2">
        <img src="https://upload.wikimedia.org/wikipedia/commons/2/21/Flag_of_Vietnam.svg" alt="VN Flag">
        <span>Hello-Vietnam</span>
      </a>
    </div>

    <div class="actions">
      <button id="loginBtn">Đăng Nhập</button>
      <button id="logoutBtn" style="display:none;background:#555;color:#fff;border-radius:20px;padding:8px 14px;border:none;">Đăng Xuất</button>
      <div id="userAvatar" style="width:36px;height:36px;border-radius:50%;background:#4caf50;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold"></div>
    </div>
  </nav>

  <div class="main-layout">
    <!-- FEED: form + posts (dọc) -->
    <div class="content-feed">
      <div class="module-card">
        <form id="postForm">
          <input type="text" id="title" placeholder="Tiêu đề bài viết" required />
          <div style="height:8px"></div>
          <textarea id="content" placeholder="Nội dung" rows="4" required></textarea>
          <div style="height:8px"></div>
          <input type="file" id="fileInput" accept="image/*" />
          <div style="height:8px"></div>
          <button type="submit">Đăng bài</button>
        </form>
      </div>

      <!-- Nơi JS sẽ chèn các bài viết (xếp dọc vì .content-feed là column) -->
      <div id="posts"></div>
    </div>

    <!-- SIDEBAR (giữ nguyên nội dung nếu cần) -->
    <div class="sidebar">
      <div class="module-card profile-module">
        <img src="https://i.pravatar.cc/150?img=4" alt="Profile Avatar" class="main-avatar" style="width:70px;height:70px;border-radius:50%;display:block;margin:0 auto 10px;">
        <h3 style="text-align:center;margin:0 0 6px">Mai Phương Nguyễn</h3>
        <p class="muted" style="text-align:center;margin:0 0 8px">Extratta | Elite Traveller</p>
        <div class="progress-bar-container" style="width:80%;height:10px;background:#eee;border-radius:10px;margin:10px auto;">
          <div class="progress-fill" style="width:26%;height:100%;background:#4CAF50;border-radius:10px;"></div>
        </div>
      </div>

      <div class="module-card">
        <h4 style="margin-top:0">Travel Challenges</h4>
        <div class="challenge-grid">
          <div class="challenge-item"><img src="https://picsum.photos/400/300?random=14" alt=""></div>
          <div class="challenge-item"><img src="https://picsum.photos/400/300?random=15" alt=""></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // --- Thay config Firebase của bạn vào đây (mình giữ config bạn đã dùng, đã chỉnh storageBucket) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDIlrYG0B2dYtL29TSYFphtqFXtz-kefqc",
      authDomain: "hello-vietnam-5331d.firebaseapp.com",
      projectId: "hello-vietnam-5331d",
      storageBucket: "hello-vietnam-5331d.appspot.com",
      messagingSenderId: "723581660067",
      appId: "1:723581660067:web:e0721959ae942cf0c88816",
      measurementId: "G-1K0LV7SLL7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI elements
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userAvatar = document.getElementById("userAvatar");
    const postForm = document.getElementById("postForm");
    const fileInput = document.getElementById("fileInput");
    const postsContainer = document.getElementById("posts");

    // helper: escape HTML to prevent injection
    function escapeHtml(text){
      if(!text) return "";
      return String(text).replace(/[&<>"']/g, function(m){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
      });
    }

    // Auth actions
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error("Login error:", err);
        alert("Lỗi đăng nhập: " + err.message);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error("Logout error:", err);
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        userAvatar.style.backgroundImage = `url(${user.photoURL})`;
        userAvatar.style.backgroundSize = "cover";
        userAvatar.textContent = "";
      } else {
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        userAvatar.style.backgroundImage = "";
        userAvatar.textContent = "P";
      }
    });

    // submit post
    postForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("title").value.trim();
      const content = document.getElementById("content").value.trim();
      const file = fileInput.files[0];

      if(!title || !content){
        alert("Vui lòng nhập tiêu đề và nội dung");
        return;
      }

      try {
        // optional: only allow logged-in users (comment out if you want anonymous)
        // if(!auth.currentUser) { alert("Bạn cần đăng nhập để đăng bài"); return; }

        let imageUrl = "";
        if (file) {
          const path = "posts/" + Date.now() + "_" + file.name;
          const storageRef = ref(storage, path);
          await uploadBytes(storageRef, file);
          imageUrl = await getDownloadURL(storageRef);
        }

        await addDoc(collection(db, "posts"), {
          title,
          content,
          imageUrl,
          createdAt: serverTimestamp(),
          userId: auth.currentUser ? auth.currentUser.uid : null,
          user: auth.currentUser ? auth.currentUser.displayName : "Ẩn danh",
          avatar: auth.currentUser ? auth.currentUser.photoURL : ""
        });

        postForm.reset();
        loadPosts(); // reload
        alert("Đăng bài thành công!");
      } catch (err) {
        console.error("Lỗi đăng bài:", err);
        alert("Lỗi khi đăng bài: " + err.message);
      }
    });

    // load posts (ordered newest first)
    async function loadPosts(){
      postsContainer.innerHTML = ""; // clear
      try {
        const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        if (snap.empty) {
          postsContainer.innerHTML = '<div class="module-card muted">Chưa có bài viết nào. Hãy đăng bài đầu tiên!</div>';
          return;
        }
        snap.forEach(doc => {
          const data = doc.data();
          const timeStr = (data.createdAt && data.createdAt.toDate) ? data.createdAt.toDate().toLocaleString() : "";
          postsContainer.innerHTML += `
            <div class="post-card">
              ${data.imageUrl ? `<div class="post-image"><img src="${escapeHtml(data.imageUrl)}" alt=""></div>` : ''}
              <div class="post-header">
                <img src="${escapeHtml(data.avatar || 'https://i.pravatar.cc/150')}" alt="avatar" class="avatar">
                <div>
                  <div class="username">${escapeHtml(data.user || 'Ẩn danh')}</div>
                  <div class="muted">${escapeHtml(timeStr)}</div>
                </div>
              </div>
              <div class="post-body">
                <h3 style="margin:0 0 8px">${escapeHtml(data.title)}</h3>
                <p style="margin:0">${escapeHtml(data.content)}</p>
              </div>
              <div class="post-footer">
                <span><i class="fas fa-thumbs-up"></i> Like</span>
                <span><i class="fas fa-comment"></i> Comment</span>
              </div>
            </div>
          `;
        });
      } catch (err) {
        console.error("Lỗi load bài:", err);
        postsContainer.innerHTML = '<div class="module-card muted">Lỗi khi tải bài viết. Xem console để biết chi tiết.</div>';
      }
    }

    // initial load
    loadPosts();
  </script>
</body>
</html>
